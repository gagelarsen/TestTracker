{% extends "test_tracker/layout.html" %}

{% block test_tracker_content %}
<div class="row">
    <div class="col-sm-3 col-md-2 sidebar">
        <ul class="nav nav-sidebar">

            <li><h3>Filter Options:<h3></li>
            <li><input type="checkbox" id="showInactiveCases"> Show Inactive Test Cases</li>
            {% if user.is_authenticated %}
            <li><input type="checkbox" id="showActions"> Show Actions</li>
            {% endif %}
            <li><input id="test-case-filter-text" type="text" placeholder="Search..."></li>
            {% if user.is_authenticated %}
                <li><h3>Actions:<h3></li>
                <li class="dashboard-action-button">
                    <button data-id="{% url 'create_testcase'%}" class="create-testcase btn btn-sm btn-success">
                        <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span> Create TestCase
                    </button>
                </li>
                <li class="dashboard-action-button">
                    <form action="{% url 'upload_results' product.name product.version %}">
                        <input type="submit" class="btn btn-sm btn-success" value="Upload Test Results">
                    </form>
                </li>
                <li class="dashboard-action-button">
                    <form action="{% url 'upload_testcases' product.name product.version %}">
                        <input type="submit" class="btn btn-sm btn-success" value="Upload Test Cases">
                    </form>
                </li>
                {% if user.is_staff %}
                <li class="dashboard-action-button">
                    <button data-id="{% url 'create_testcategory'%}" class="create-test-category btn btn-sm btn-success">
                        <span class="glyphicon glyphicon-plus" aria-hidden="true"></span> Create Test Category
                    </button>
                </li>
                <li class="dashboard-action-button">
                    <button data-id="{% url 'create_testsubcategory'%}" class="create-test-subcategory btn btn-sm btn-success">
                        <span class="glyphicon glyphicon-plus" aria-hidden="true"></span> Create Test Subcategory
                    </button>
                </li>
                <li class="dashboard-action-button">
                    <button data-id="{% url 'create_teststatus'%}" class="create-test-status btn btn-sm btn-success">
                        <span class="glyphicon glyphicon-plus" aria-hidden="true"></span> Create Test Status
                    </button>
                </li>
                {% endif %}
            {% endif %}
        </ul>
    </div>
    <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
        <h1 class="page-header">{{ product.get_product_string }}</h1>
        <ul class="nav nav-tabs">
          <li class="active"><a data-toggle="tab" href="#dashboard">Dashboard</a></li>
          <li><a data-toggle="tab" href="#info">Info</a></li>
        </ul>

        <div class="tab-content">
            <div id="dashboard" class="tab-pane fade in active">
                <table id="test-tracker-dashboard" class="table table-bordered test-tracker-dashboard">
                    <thead>
                        <th class="sortable">Test Case</th>
                        <th class="sortable">Category</th>
                        <th class="sortable">Subcategory</th>
                        {% if user.is_authenticated %}
                        {% endif %}
                        {% for date in dates %}
                            <th class="sortable">{{ date }}
                                <button data-url="{% url 'daily_stats' product.name product.version date.day date.month date.year %}" class="daily-stats btn btn-xs btn-info">
                                    <span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span>
                                </button>
                            </th>
                        {% endfor %}
                    </thead>

                    <tbody id="dashboard-table">
                    {% for case in testcases %}
                    <tr class="test-active-{{ case.testcase.active }}">
                        <td>
                            {{ case.testcase.name }}
                            {% if user.is_authenticated %}
                            <div class="dashboard-actions">
                                <button type="button" class="update-testcase btn btn-sm btn-primary" data-id="{% url 'update_testcase' case.testcase.pk %}">
                                    <span class="glyphicon glyphicon-pencil"></span>
                                </button>
                                <button type="button" class="create-testresult btn btn-sm btn-primary" data-id="{% url 'create_result' %}">
                                    <span class="glyphicon glyphicon-plus"></span>
                                </button>
                            </div>
                            {% endif %}
                        </td>
                        <td>{{ case.testcase.category.category }}</td>
                        <td>{{ case.testcase.subcategory.subcategory }}</td>
                        {% for r in case.results %}
                            {% if r.0 %}
                                <td class="dashboard-status-cell" title="{{ r.0.status.status }}&#013;{{ r.0.author }}&#013;{{ r.0.note }}" bgcolor="{{ r.0.status.hex_color }}">
                                    {% if user.is_authenticated %}
                                    <a style="color: {{ r.0.status.text_hex_color }};" class="update-testresult" data-id="{% url 'update_result' r.0.pk %}">
                                        {{ r.0.status.status }}
                                    </a>
                                    {% else %}
                                    {{ r.0.status.status }}
                                    {% endif %}
                                </td>
                            {% else %}
                                <td></td>
                            {% endif %}
                        {% endfor %}
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            <div id="info" class="tab-pane fade">

            </div>
        </div>
    </div>
</div>

<script>
    function toggle_view(selector, checked_state) {
        $(selector).toggle(checked_state)
    }

    $('#showInactiveCases').click(function() {
        toggle_view(".test-active-False", this.checked);
        localStorage.setItem("show_active_value", this.checked);
    });
    $('#showActions').click(function() {
        toggle_view(".dashboard-actions", this.checked);
        localStorage.setItem("show_actions_value", this.checked);
    });

    $("#test-case-filter-text").on("keyup", function() {
      show_active_value = localStorage.getItem('show_active_value') == 'true' ? true : false;
      var value = $(this).val().toLowerCase();
      localStorage.setItem("dashboard_filter_string", value);
      $("#dashboard-table tr").filter(function() {
        var text = $(this).text().toLowerCase();
        var idx = text.indexOf(value) > -1
        if (show_active_value || $(this).hasClass('test-active-True')) {
          $(this).toggle(idx)
        }
      });
    });

    $(document).ready(function() {
        show_active_value = localStorage.getItem('show_active_value') == 'true' ? true : false;
        $('#showInactiveCases').prop('checked', show_active_value);
        toggle_view(".test-active-False", show_active_value);
        show_actions_value = localStorage.getItem('show_actions_value') == 'true' ? true : false;
        $('#showActions').prop('checked', show_actions_value);
        toggle_view(".dashboard-actions", show_actions_value);

        dashboard_filter_string = localStorage.getItem('dashboard_filter_string') || '';
        if (dashboard_filter_string != '') {
            text_box = $('#test-case-filter-text');
            text_box.val(dashboard_filter_string);
            $('#test-case-filter-text').keyup()
        }
    });

    $(document).ready(function() {
        $(".create-product").modalForm({
            formURL: "{% url 'create_product' %}"
        });
    });
    $(".update-product").each(function () {
        $(this).modalForm({formURL: $(this).data('id')});
    });

    $(document).ready(function() {
        $(".create-testcase").modalForm({
            formURL: "{% url 'create_testcase' %}"
        });
    });

    $(document).ready(function() {
        $(".create-test-category").modalForm({
            formURL: "{% url 'create_testcategory' %}"
        });
    });

    $(document).ready(function() {
        $(".create-test-subcategory").modalForm({
            formURL: "{% url 'create_testsubcategory' %}"
        });
    });

    $(document).ready(function() {
        $(".create-test-status").modalForm({
            formURL: "{% url 'create_teststatus' %}"
        });
    });

    $(".update-testcase").each(function () {
        $(this).modalForm({formURL: $(this).data('id')});
    });

    $(document).ready(function() {
        $(".create-testresult").modalForm({
            formURL: "{% url 'create_result' %}"
        });
    });

    $(".update-testresult").each(function () {
        $(this).modalForm({formURL: $(this).data('id')});
    });

    $(".daily-stats").each(function () {
        var t = $(this)
        var url = $(this).data('url')
        $(this).modalForm({formURL: $(this).data('url')});
    });

$('th').click(function(){
    var table = $(this).parents('thead').eq(0).parents('table').eq(0)
    var rows = table.find('tr:gt(0)').toArray().sort(comparer($(this).index()))
    this.asc = !this.asc
    if (!this.asc){rows = rows.reverse()}
    for (var i = 0; i < rows.length; i++){table.append(rows[i])}
})
function comparer(index) {
    return function(a, b) {
        var valA = getCellValue(a, index), valB = getCellValue(b, index)
        return $.isNumeric(valA) && $.isNumeric(valB) ? valA - valB : valA.toString().localeCompare(valB)
    }
}
function getCellValue(row, index){ return $(row).children('td').eq(index).text() }

</script>

{% endblock %}